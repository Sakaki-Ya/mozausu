const canvas=new fabric.Canvas("c");let imgType;$("#file").on("change",e=>{fabric.textureSize=2048,$("#view, #notImg, #overSize, #footer").hide(),reset();const file=e.target.files,fileType=file[0].type,imgSize=file[0].size;if(!fileType.match("image.*"))return $("#notImg").fadeIn(),void($("#file")[0].value="");if(imgSize>17e5)return $("#overSize").fadeIn(),void($("#file")[0].value="");imgSize>1e6&&(fabric.textureSize=4096);const fr=new FileReader(e);fr.onload=e=>{fileType.match("image.png")&&(imgType="png"),input(e.target.result),$("#view").show(),viewIn(),$("#list").scrollLeft(0),arrowVisibility();const optHeight=$("#optPanel").outerHeight();$("#cnvArea").css("padding-bottom",optHeight)},fr.readAsDataURL(e.target.files[0])});const input=url=>{fabric.Image.fromURL(url,origImg=>{resizeToCanvas(origImg),canvas.add(origImg).renderAll(),canvas.selection=origImg.selectable=!1})},resizeToCanvas=imgObj=>{canvas.setWidth($(".container").width());const resizeScale=canvas.width/imgObj.width;imgObj.scale(resizeScale),canvas.setHeight(imgObj.height*resizeScale)};let mode="";$(window).on("resize",()=>resize());const resize=()=>{if($("#view").is(":visible")&&""===mode){canvas.setWidth($(".container").width());const obj=canvas.getObjects(),origImg=obj[0],resizeScale=canvas.width/origImg.width;for(let i=0;i<obj.length;i++)obj[i].scale(resizeScale),canvas.setHeight(obj[i].height*resizeScale);arrowVisibility();const optHeight=$("#optPanel").outerHeight();$("#cnvArea").css("padding-bottom",optHeight)}};let stroke,circle;$("#select").on("click",()=>{$("#select").prop("checked")?selectArea():clear()});const selectArea=()=>{canvas.hoverCursor="crosshair",mode="add",canvas.on("mouse:down",down),canvas.on("mouse:dblclick",copyObj),$("canvas").on("doubletap",copyObj)},down=e=>{const pos=canvas.getPointer(e);if("add"===mode&&(stroke=new fabric.Polygon([{x:pos.x,y:pos.y}],{left:pos.x,top:pos.y,fill:!1,stroke:"rgba(0,177,235,.87)",strokeWidth:2,objectCaching:!1}),canvas.add(stroke),mode="edit",canvas.on("mouse:move",move)),"edit"===mode){const points=stroke.get("points");points.push({x:pos.x,y:pos.y})}"add"!==mode&&"edit"!==mode||(circle=new fabric.Circle({left:pos.x,top:pos.y,originX:"center",originY:"center",fill:"rgba(0,87,145,.87)",radius:4,selectable:!1}),canvas.add(circle))},move=e=>{if("edit"===mode){const pos=canvas.getPointer(e),points=stroke.get("points");points[points.length-1].x=pos.x,points[points.length-1].y=pos.y,canvas.renderAll()}},copyObj=()=>{const obj=canvas.getObjects(),origImg=obj[0];origImg.clone(copy=>{copy.set({scaleX:origImg.scaleX,scaleY:origImg.scaleY}),copy.selectable=!1,clippingObj(copy)})},clippingObj=copy=>{const polygon=new fabric.Polygon(stroke.get("points")),polyScale=copy.width/(copy.width*copy.scaleX);polygon.scale(polyScale),polygon.set({left:-copy.width/2+polygon.left*polyScale,top:-copy.height/2+polygon.top*polyScale}),copy.clipPath=polygon,canvas.remove(stroke);const circles=canvas.getObjects();for(let i=1;i<circles.length;i++)canvas.remove(circles[i]);$("#select").prop("disabled",!0),$("#onOff").prop("disabled",!1),$("#value")[0].value=.25,mode="",canvas.hoverCursor="all-scroll",$(".valueItem").fadeIn(),valueIn(),blurObj(copy)},blurObj=copy=>{const filter=new fabric.Image.filters.Blur({blur:parseFloat($("#value").val())});copy.filters.push(filter),copy.applyFilters(),canvas.add(copy).renderAll(),$("#value").on("input",{copy:copy},slide)},slide=e=>blurValue(e.data.copy,parseFloat(e.target.value)),blurValue=(copy,value)=>{const obj=canvas.getObjects(),bulrCache=obj[1];copy.filters[0].blur=value,copy.applyFilters(),canvas.remove(bulrCache).add(copy).renderAll()};let zoom=canvas.getZoom(),panning,prevX,prevY;$("#zoomIn").on("click",()=>{zoom<2&&(zoom+=.1,canvas.setZoom(zoom))}),$("#zoomOut").on("click",()=>{zoom>.5&&(zoom-=.1,canvas.setZoom(zoom))}),canvas.on("mouse:down",e=>{if("all-scroll"===canvas.hoverCursor&&(panning=!0,window.TouchEvent&&e.e instanceof TouchEvent)){const{clientX:clientX,clientY:clientY}=e.e.touches[0];prevX=clientX,prevY=clientY}}),canvas.on("mouse:move",e=>{if(panning){let delta;if(window.TouchEvent&&e.e instanceof TouchEvent){const{clientX:clientX,clientY:clientY}=e.e.touches[0];return delta=new fabric.Point(clientX-prevX,clientY-prevY),prevX=clientX,prevY=clientY,void canvas.relativePan(delta)}delta=new fabric.Point(e.e.movementX,e.e.movementY),canvas.relativePan(delta)}}),canvas.on("mouse:up",()=>{panning=!1}),$("#onOff").on("click",()=>{const obj=canvas.getObjects();if(2!==obj.length)return;const blurObj=obj[1];if(!0===$("#onOff").prop("checked"))return blurObj.opacity=0,void canvas.remove(blurObj).add(blurObj).renderAll();blurObj.opacity=1,canvas.remove(blurObj).add(blurObj).renderAll()}),$("#clear").on("click",()=>clear());const clear=()=>{const obj=canvas.getObjects(),origImg=obj[0];reset(),canvas.add(origImg).renderAll(),origImg.selectable=!1},reset=()=>{canvas.clear(),zoom=1,canvas.setZoom(zoom),canvas.setViewportTransform([1,0,0,1,0,0]),$("#select").prop("disabled",!1),$("#select").prop("checked",!1),$("#onOff").prop("disabled",!0),$("#onOff").prop("checked",!1),$("#value")[0].value=.25,canvas.hoverCursor="all-scroll",mode="",canvas.off("mouse:down",down).off("mouse:move",move).off("mouse:dblclick",copyObj),$("canvas").off("doubletap",copyObj),$("#value").off("input",slide),valueOut(),$(".valueItem").fadeOut(1200)};$("#dl").on("click",()=>{zoom=1,canvas.setZoom(zoom),canvas.setViewportTransform([1,0,0,1,0,0]);const obj=canvas.getObjects(),origImg=obj[0];canvas.width=origImg.width,canvas.height=origImg.height;const resizeScale=canvas.width/origImg.width;for(let i=0;i<obj.length;i++)obj[i].scale(resizeScale);if("png"===imgType){const dataURL=canvas.toDataURL({format:"png"});return void imgDownload(dataURL)}const dataURL=canvas.toDataURL({format:"jpeg",quality:1});imgDownload(dataURL)});const imgDownload=dataURL=>{const origName=$("#file")[0].files[0].name,a=$("#hideDl")[0];a.href=dataURL,a.download=`mozausu-${origName}`,a.click(),resize()};$("#close").on("click",async()=>{reset(),await viewOut(),$("#view").hide(),$("#footer").fadeIn(),$("#file")[0].value=""}),$("#list").scroll(()=>arrowVisibility());const arrowVisibility=()=>{const scrollPosition=$("#list").scrollLeft(),maxPostion=$("#list").get(0).scrollWidth-$("#list").get(0).clientWidth;let leftVisibility="visible",rightVisibility="visible";0===scrollPosition&&(leftVisibility="hidden"),scrollPosition===maxPostion&&(rightVisibility="hidden"),$("#arrowLeft").css("visibility",leftVisibility),$("#arrowRight").css("visibility",rightVisibility)};$("#arrowLeft").on("click",()=>{const scrollPosition=$("#list").scrollLeft();scrollPosition>0?$("#list").scrollLeft(scrollPosition-40):$("#list").scrollLeft(0)}),$("#arrowRight").on("click",()=>{const scrollPosition=$("#list").scrollLeft(),maxScroll=$("#list").get(0).scrollWidth-$("#list").get(0).clientWidth;scrollPosition<maxScroll?$("#list").scrollLeft(scrollPosition+40):$("#list").scrollLeft(maxScroll)}),$(".openHowto").on("click",()=>{$("#video").prop("src","https://www.youtube.com/embed/1GbHbYI_7OQ"),$("#optPanel").is(":visible")&&$("#optPanel").fadeOut(100),$("body").prop("id","inModal"),$("#howto").addClass("is-active"),modalIn($("#howto")[0])}),$("#openPolicy").on("click",()=>{$("body").prop("id","inModal"),$("#policy").addClass("is-active"),modalIn($("#policy")[0])}),$(".closeModal, .modal-background").on("click",async()=>{let modal;$("body").removeAttr("id","inModal"),$("#howto").is(":visible")&&($("#video").prop("src",""),modal=$("#howto")),$("#policy").is(":visible")&&(modal=$("#policy")),await modalOut(modal[0]),$("#view").is(":visible")&&$("#optPanel").fadeIn(100),modal.removeClass("is-active")});const viewIn=()=>{anime({targets:"canvas",scale:[0,1]}),anime({targets:"#list li, .arrow",translateY:["+=600px","0"],delay:anime.stagger(55)})},valueIn=()=>{anime({targets:".valueItem",translateX:["-=1200px","0%"],duration:1200,easing:"spring(1, 100, 13, 30)"})},valueOut=()=>{anime({targets:".valueItem",translateX:["0%","+=1200px"],duration:1200,easing:"spring(1, 100, 13, 30)"})},viewOut=()=>(anime({targets:"canvas",scale:[1,0],duration:250}),anime({targets:"#list li, .arrow",translateY:["0%","+=600px"],delay:anime.stagger(55),duration:250}).finished),modalIn=modal=>{anime({targets:modal,translateY:["-=900px","0%"]})},modalOut=modal=>anime({targets:modal,translateY:["0%","+=900px"],duration:900}).finished;